<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SPCS Bokföring (HTML) – v2</title>
  <style>
    :root{
      --bg:#21273c;
      --panel:#2a3150;
      --panel2:#1b2033;
      --text:#e8ecff;
      --muted:#b8c0ff;
      --accent:#7aa2ff;
      --danger:#ff6b6b;
      --ok:#5dffb3;
      --border:rgba(255,255,255,.12);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      background:linear-gradient(180deg, var(--bg), #14182a 65%);
      color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:10;
      background:rgba(33,39,60,.85);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--border);
    }
    .wrap{max-width:1250px;margin:0 auto;padding:16px}
    h1{font-size:18px;margin:0 0 6px}
    .sub{color:var(--muted);font-size:13px}
    nav{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
    nav button{
      border:1px solid var(--border);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:8px 10px;
      border-radius:10px;
      cursor:pointer;
    }
    nav button.active{
      background:rgba(122,162,255,.18);
      border-color:rgba(122,162,255,.45);
    }
    main{padding:18px 0 40px}
    .grid{display:grid;grid-template-columns: 1fr;gap:14px}
    @media(min-width: 980px){
      .grid.two{grid-template-columns: 1.1fr .9fr}
      .grid.three{grid-template-columns: 1fr 1fr 1fr}
    }
    .card{
      background:linear-gradient(180deg, rgba(42,49,80,.92), rgba(27,32,51,.92));
      border:1px solid var(--border);
      border-radius:14px;
      box-shadow: var(--shadow);
      padding:14px;
    }
    .card h2{font-size:15px;margin:0 0 10px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input, select, textarea{
      width:100%;
      padding:10px 10px;
      border-radius:10px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.06);
      color:var(--text);
      outline:none;
    }
    textarea{min-height:90px; font-family:var(--mono); font-size:12px}
    input[type="date"]{padding:9px 10px}
    .btn{
      border:1px solid var(--border);
      background:rgba(255,255,255,.08);
      color:var(--text);
      padding:9px 11px;
      border-radius:10px;
      cursor:pointer;
    }
    .btn.primary{
      background:rgba(122,162,255,.22);
      border-color:rgba(122,162,255,.45);
    }
    .btn.danger{
      background:rgba(255,107,107,.16);
      border-color:rgba(255,107,107,.45);
    }
    .btn.ok{
      background:rgba(93,255,179,.14);
      border-color:rgba(93,255,179,.35);
    }
    .muted{color:var(--muted);font-size:12px}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid var(--border);
      font-size:12px;color:var(--muted);
    }
    table{width:100%;border-collapse:collapse;font-size:13px}
    th, td{padding:9px 8px;border-bottom:1px solid rgba(255,255,255,.08);vertical-align:top}
    th{color:var(--muted);text-align:left;font-weight:600}
    td.num{text-align:right;font-family:var(--mono)}
    .right{margin-left:auto}
    .err{color:var(--danger);font-size:12px}
    .oktxt{color:var(--ok);font-size:12px}
    .small{font-size:12px}
    .mono{font-family:var(--mono)}
    .split{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .sep{height:1px;background:rgba(255,255,255,.08);margin:12px 0}
    .hidden{display:none !important}
    .kv{display:grid;grid-template-columns: 170px 1fr;gap:8px 12px;font-size:13px}
    .kv div:nth-child(odd){color:var(--muted)}
    .footer-note{color:var(--muted);font-size:12px;margin-top:10px}
    .badge{
      display:inline-flex;align-items:center;gap:6px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.06);
      padding:6px 10px;border-radius:999px;
      font-size:12px;color:var(--muted);
    }
    .kbd{font-family:var(--mono);font-size:12px;border:1px solid rgba(255,255,255,.15);padding:2px 6px;border-radius:6px;background:rgba(255,255,255,.06)}
    @media print{
      header, nav, .no-print{display:none !important}
      body{background:#fff;color:#000}
      .card{box-shadow:none;border:1px solid #ccc;background:#fff}
      .muted{color:#333}
      table, th, td{border-bottom:1px solid #ddd}
      .pill, .badge{border:1px solid #ccc;background:#fff;color:#000}
    }
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="split">
      <div>
        <h1>SPCS Bokföring (HTML) – v2</h1>
        <div class="sub">Offline • IndexedDB (primärt) + fallback • Periodlås • Logg • SIE import/export • Rapporter</div>
      </div>
      <div class="right pill" id="statusPill">Startar…</div>
      <div class="pill" id="storagePill">Lagring: —</div>
    </div>

    <nav id="tabs" class="no-print">
      <button data-tab="start" class="active">Start</button>
      <button data-tab="foretag">Företag</button>
      <button data-tab="kontoplan">Kontoplan</button>
      <button data-tab="verifikat">Verifikat</button>
      <button data-tab="rapporter">Rapporter</button>
      <button data-tab="importexport">Import/Export</button>
      <button data-tab="logg">Logg</button>
    </nav>
  </div>
</header>

<main class="wrap">
  <section id="tab-start" class="grid two">
    <div class="card">
      <h2>Översikt</h2>
      <div class="kv" id="overview"></div>
      <div class="sep"></div>
      <div class="row no-print">
        <button class="btn primary" id="btnPrefill">Skapa BAS-minimal kontoplan</button>
        <button class="btn" id="btnDemo">Skapa demo-verifikat</button>
        <button class="btn danger" id="btnReset">Nollställ allt (radera data)</button>
      </div>
      <div class="footer-note">
        Prototypen är ett fristående offline-system. För full SPCS-paritet krävs mer (reskontra, faktura, lön, avancerad moms, periodiseringar, mm).
      </div>
    </div>

    <div class="card">
      <h2>Snabbkontroller</h2>
      <div id="quickChecks" class="small muted">—</div>
      <div class="sep"></div>
      <div class="row no-print">
        <button class="btn ok" id="btnBackupFile">Exportera JSON (fil)</button>
        <button class="btn" id="btnSIEFile">Exportera SIE (fil)</button>
        <button class="btn" id="btnPrintStart">Skriv ut</button>
      </div>
      <div class="sep"></div>
      <div class="muted small">
        Tips: <span class="kbd">Ctrl/Cmd + P</span> funkar för utskrifter av rapporter också.
      </div>
    </div>
  </section>

  <section id="tab-foretag" class="hidden grid two">
    <div class="card">
      <h2>Företagsinställningar</h2>
      <div class="row">
        <div style="flex:1;min-width:240px">
          <label>Företagsnamn</label>
          <input id="cName" placeholder="Ex: Andreas AB" />
        </div>
        <div style="flex:1;min-width:240px">
          <label>Organisationsnummer</label>
          <input id="cOrg" placeholder="Ex: 556123-4567" />
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <div style="flex:1;min-width:240px">
          <label>Räkenskapsår – start</label>
          <input id="fyStart" type="date" />
        </div>
        <div style="flex:1;min-width:240px">
          <label>Räkenskapsår – slut</label>
          <input id="fyEnd" type="date" />
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <div style="flex:1;min-width:240px">
          <label>Standard verifikationsserie</label>
          <input id="defaultSeries" placeholder="A" />
        </div>
        <div style="flex:1;min-width:240px">
          <label>Nästa verifikationsnummer (fallback)</label>
          <input id="nextVoucher" type="number" min="1" />
        </div>
      </div>

      <div class="sep"></div>

      <h2>Periodlås</h2>
      <div class="row">
        <div style="flex:1;min-width:240px">
          <label>Lås bokföring t.o.m. (inklusive)</label>
          <input id="lockUntil" type="date" />
        </div>
        <div style="flex:1;min-width:240px">
          <label>Info</label>
          <div class="badge" id="lockInfo">—</div>
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <button class="btn primary" id="btnSaveCompany">Spara</button>
        <button class="btn" id="btnUnlock">Lås upp (ta bort låsdatum)</button>
      </div>
      <div id="companyMsg" class="muted" style="margin-top:10px"></div>
    </div>

    <div class="card">
      <h2>Moms-koder</h2>
      <div class="muted small">
        Konton kan ha moms-kod. Momsrapporten summerar moms-konton per kod.
      </div>
      <div class="sep"></div>
      <div class="muted small mono">
        NONE, OUT25, OUT12, OUT6, IN25, IN12, IN6
      </div>
      <div class="sep"></div>
      <div class="muted small">
        För “riktig” svensk momsrapport (rutor, EU-handel, omvänd moms, mm) behöver man fler koder och regler. Men den här ger snabb kontroll.
      </div>
    </div>
  </section>

  <section id="tab-kontoplan" class="hidden grid two">
    <div class="card">
      <h2>Lägg till / redigera konto</h2>
      <div class="row">
        <div style="flex:0.6;min-width:120px">
          <label>Konto</label>
          <input id="accNo" placeholder="1930" />
        </div>
        <div style="flex:1.4;min-width:240px">
          <label>Namn</label>
          <input id="accName" placeholder="Företagskonto" />
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <div style="flex:1;min-width:220px">
          <label>Typ</label>
          <select id="accType">
            <option value="asset">Tillgång</option>
            <option value="liability">Skuld</option>
            <option value="equity">Eget kapital</option>
            <option value="revenue">Intäkt</option>
            <option value="expense">Kostnad</option>
          </select>
        </div>
        <div style="flex:1;min-width:220px">
          <label>Moms-kod</label>
          <select id="accVAT">
            <option value="NONE">NONE</option>
            <option value="OUT25">OUT25</option>
            <option value="OUT12">OUT12</option>
            <option value="OUT6">OUT6</option>
            <option value="IN25">IN25</option>
            <option value="IN12">IN12</option>
            <option value="IN6">IN6</option>
          </select>
        </div>
      </div>
      <div class="row" style="margin-top:12px" class="no-print">
        <button class="btn primary" id="btnAccSave">Spara konto</button>
        <button class="btn" id="btnAccClear">Rensa</button>
        <button class="btn danger" id="btnAccDelete">Ta bort konto</button>
      </div>
      <div id="accMsg" class="muted" style="margin-top:10px"></div>
    </div>

    <div class="card">
      <h2>Kontoplan</h2>
      <div class="row" style="align-items:flex-end">
        <div style="flex:1;min-width:240px">
          <label>Sök</label>
          <input id="accSearch" placeholder="Sök 1930 eller namn…" />
        </div>
        <button class="btn no-print" id="btnAccSort">Sortera (konto)</button>
      </div>
      <div class="sep"></div>
      <div style="max-height:520px;overflow:auto">
        <table>
          <thead>
            <tr><th>Konto</th><th>Namn</th><th>Typ</th><th>Moms</th></tr>
          </thead>
          <tbody id="accTable"></tbody>
        </table>
      </div>
      <div class="footer-note">Klicka på ett konto för att ladda det i formuläret.</div>
    </div>
  </section>

  <section id="tab-verifikat" class="hidden grid two">
    <div class="card">
      <h2>Nytt verifikat</h2>
      <div class="row">
        <div style="flex:1;min-width:200px">
          <label>Datum</label>
          <input id="vDate" type="date" />
        </div>
        <div style="flex:0.6;min-width:120px">
          <label>Serie</label>
          <input id="vSeries" placeholder="A" />
        </div>
        <div style="flex:0.8;min-width:140px">
          <label>Ver.nr</label>
          <input id="vNo" type="number" min="1" />
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <div style="flex:1;min-width:240px">
          <label>Text</label>
          <input id="vText" placeholder="Ex: Kundfaktura 1001" />
        </div>
      </div>

      <div class="sep"></div>

      <h2 style="margin-top:0">Konteringsrader</h2>
      <div class="muted small">Summor måste balansera innan du kan spara. Periodlås blockerar sparande i låst period.</div>
      <div class="sep"></div>

      <div id="lines"></div>

      <div class="row" style="margin-top:10px">
        <button class="btn no-print" id="btnAddLine">+ Lägg till rad</button>
        <div class="right">
          <span class="pill">Debet: <span class="mono" id="sumDebit">0.00</span></span>
          <span class="pill">Kredit: <span class="mono" id="sumCredit">0.00</span></span>
          <span class="pill">Diff: <span class="mono" id="sumDiff">0.00</span></span>
        </div>
      </div>

      <div class="row" style="margin-top:12px" class="no-print">
        <button class="btn primary" id="btnSaveVoucher">Spara verifikat</button>
        <button class="btn" id="btnClearVoucher">Rensa</button>
        <button class="btn danger" id="btnDeleteVoucher">Ta bort (om laddat)</button>
      </div>
      <div id="voucherMsg" class="muted" style="margin-top:10px"></div>
    </div>

    <div class="card">
      <h2>Verifikationslista</h2>
      <div class="row" style="align-items:flex-end">
        <div style="flex:1;min-width:200px">
          <label>Period från</label>
          <input id="listFrom" type="date" />
        </div>
        <div style="flex:1;min-width:200px">
          <label>Period till</label>
          <input id="listTo" type="date" />
        </div>
        <div style="flex:1;min-width:220px">
          <label>Sök (text/serie/nr)</label>
          <input id="voucherSearch" placeholder="ex: A12 eller 'insättning'…" />
        </div>
        <button class="btn no-print" id="btnRefreshList">Uppdatera</button>
      </div>
      <div class="sep"></div>
      <div style="max-height:520px;overflow:auto">
        <table>
          <thead>
            <tr><th>Datum</th><th>Serie</th><th>Nr</th><th>Text</th><th class="num">Rader</th></tr>
          </thead>
          <tbody id="voucherTable"></tbody>
        </table>
      </div>
      <div class="footer-note">Klicka på ett verifikat för att ladda det i formuläret.</div>
    </div>
  </section>

  <section id="tab-rapporter" class="hidden grid two">
    <div class="card">
      <h2>Rapportparametrar</h2>
      <div class="row">
        <div style="flex:1;min-width:200px">
          <label>Från</label>
          <input id="rFrom" type="date" />
        </div>
        <div style="flex:1;min-width:200px">
          <label>Till</label>
          <input id="rTo" type="date" />
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <div style="flex:1;min-width:220px">
          <label>Rapport</label>
          <select id="rType">
            <option value="trial">Saldolista</option>
            <option value="ledger">Huvudbok (per konto)</option>
            <option value="pl">Resultaträkning</option>
            <option value="bs">Balansräkning</option>
            <option value="vat">Momsrapport (v2)</option>
          </select>
        </div>
        <div style="flex:1;min-width:220px" id="ledgerAccountWrap" class="hidden">
          <label>Konto (för huvudbok)</label>
          <input id="ledgerAccount" placeholder="1930" />
        </div>
      </div>
      <div class="row no-print" style="margin-top:12px">
        <button class="btn primary" id="btnRunReport">Kör rapport</button>
        <button class="btn" id="btnCopyReport">Kopiera (text)</button>
        <button class="btn" id="btnPrintReport">Skriv ut</button>
      </div>
      <div id="reportMsg" class="muted" style="margin-top:10px"></div>
    </div>

    <div class="card">
      <h2>Resultat</h2>
      <div id="reportOut" class="small muted">—</div>
      <textarea id="reportText" class="hidden" readonly></textarea>
    </div>
  </section>

  <section id="tab-importexport" class="hidden grid two">
    <div class="card">
      <h2>Export (JSON-backup)</h2>
      <div class="muted small">Innehåller företag, kontoplan, verifikat och logg.</div>
      <div class="sep"></div>
      <div class="row no-print">
        <button class="btn ok" id="btnExportJSONFile">Ladda ner JSON</button>
        <button class="btn" id="btnExportJSONCopy">Kopiera JSON</button>
      </div>
      <textarea id="jsonOut" readonly></textarea>
    </div>

    <div class="card">
      <h2>Import (JSON)</h2>
      <div class="muted small">Import ersätter befintlig data.</div>
      <div class="sep"></div>
      <div class="row no-print">
        <input id="jsonFile" type="file" accept=".json,application/json" />
        <button class="btn primary" id="btnImportJSONFile">Importera fil</button>
      </div>
      <div class="sep"></div>
      <textarea id="jsonIn" placeholder="{ ... }"></textarea>
      <div class="row no-print" style="margin-top:10px">
        <button class="btn primary" id="btnImportJSON">Importera text</button>
      </div>
      <div id="importMsg" class="muted" style="margin-top:10px"></div>

      <div class="sep"></div>

      <h2>SIE (import/export)</h2>
      <div class="muted small">SIE-import: klistra in eller ladda upp .sie. Du kan välja om dubbletter ska ersättas.</div>
      <div class="sep"></div>
      <div class="row no-print" style="align-items:flex-end">
        <div style="flex:1;min-width:260px">
          <label>.sie fil</label>
          <input id="sieFile" type="file" accept=".sie,text/plain" />
        </div>
        <div style="flex:0.6;min-width:180px">
          <label>Dubbletter</label>
          <select id="sieDupe">
            <option value="skip">Skippa</option>
            <option value="replace">Ersätt</option>
          </select>
        </div>
        <button class="btn primary" id="btnImportSIEFile">Importera SIE</button>
      </div>
      <div class="sep"></div>
      <textarea id="sieIn" placeholder="#PROGRAM ..."></textarea>
      <div class="row no-print" style="margin-top:10px">
        <button class="btn primary" id="btnImportSIE">Importera SIE-text</button>
        <button class="btn" id="btnExportSIEFile">Ladda ner SIE</button>
        <button class="btn" id="btnCopySIE">Kopiera SIE</button>
      </div>
      <textarea id="sieOut" readonly></textarea>
    </div>
  </section>

  <section id="tab-logg" class="hidden grid two">
    <div class="card">
      <h2>Systemlogg (audit)</h2>
      <div class="muted small">
        Loggen sparar lokalt: import/export, skapade/ändrade verifikat och konton, periodlås, mm.
      </div>
      <div class="sep"></div>
      <div class="row no-print">
        <button class="btn" id="btnLogRefresh">Uppdatera</button>
        <button class="btn danger" id="btnLogClear">Töm logg</button>
      </div>
      <div class="sep"></div>
      <div style="max-height:560px;overflow:auto">
        <table>
          <thead><tr><th>Tid</th><th>Händelse</th><th>Detalj</th></tr></thead>
          <tbody id="logTable"></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <h2>Diagnostik</h2>
      <div class="kv" id="diag"></div>
      <div class="sep"></div>
      <div class="muted small">
        Om du vill migrera från tidigare v1 (localStorage) så kan v2 försöka importera automatiskt om den hittar v1-nyckeln.
      </div>
    </div>
  </section>
</main>

<script>
const DB_NAME = "spcs_html_kv";
const DB_VER = 1;
const STORE = "kv";
const KV_KEY = "db";
const FALLBACK_KEY = "spcs_html_v2_fallback";
const V1_KEY = "spcs_html_v1";

let storageMode = "init";
let kvdb = null;

function $(id){ return document.getElementById(id); }
function setStatus(text, kind=""){
  const pill = $("statusPill");
  pill.textContent = text;
  pill.style.borderColor = "rgba(255,255,255,.12)";
  pill.style.background = "rgba(255,255,255,.06)";
  if(kind==="ok"){ pill.style.borderColor="rgba(93,255,179,.35)"; pill.style.background="rgba(93,255,179,.14)";}
  if(kind==="err"){ pill.style.borderColor="rgba(255,107,107,.45)"; pill.style.background="rgba(255,107,107,.16)";}
}
function setStoragePill(){
  $("storagePill").textContent = `Lagring: ${storageMode==="idb"?"IndexedDB":"localStorage"}`;
}
function openKV(){
  return new Promise((resolve,reject)=>{
    if(!("indexedDB" in window)) return reject(new Error("IndexedDB saknas."));
    const req = indexedDB.open(DB_NAME, DB_VER);
    req.onupgradeneeded = ()=>{
      const db = req.result;
      if(!db.objectStoreNames.contains(STORE)) db.createObjectStore(STORE);
    };
    req.onsuccess = ()=>resolve(req.result);
    req.onerror = ()=>reject(req.error || new Error("IndexedDB-fel."));
  });
}
function idbGet(key){
  return new Promise((resolve,reject)=>{
    const tx = kvdb.transaction(STORE, "readonly");
    const st = tx.objectStore(STORE);
    const req = st.get(key);
    req.onsuccess = ()=>resolve(req.result);
    req.onerror = ()=>reject(req.error);
  });
}
function idbSet(key, val){
  return new Promise((resolve,reject)=>{
    const tx = kvdb.transaction(STORE, "readwrite");
    const st = tx.objectStore(STORE);
    const req = st.put(val, key);
    req.onsuccess = ()=>resolve(true);
    req.onerror = ()=>reject(req.error);
  });
}
function idbDel(key){
  return new Promise((resolve,reject)=>{
    const tx = kvdb.transaction(STORE, "readwrite");
    const st = tx.objectStore(STORE);
    const req = st.delete(key);
    req.onsuccess = ()=>resolve(true);
    req.onerror = ()=>reject(req.error);
  });
}
async function storageInit(){
  try{
    kvdb = await openKV();
    storageMode = "idb";
    setStoragePill();
    return true;
  }catch(e){
    console.warn(e);
    storageMode = "ls";
    setStoragePill();
    return false;
  }
}
async function kvLoad(){
  if(storageMode==="idb"){
    const raw = await idbGet(KV_KEY);
    return raw || null;
  }else{
    return localStorage.getItem(FALLBACK_KEY);
  }
}
async function kvSave(raw){
  if(storageMode==="idb") await idbSet(KV_KEY, raw);
  else localStorage.setItem(FALLBACK_KEY, raw);
}
async function kvReset(){
  if(storageMode==="idb") await idbDel(KV_KEY);
  else localStorage.removeItem(FALLBACK_KEY);
}

function defaultDB(){
  const y = new Date().getFullYear();
  return {
    meta: {version:2, createdAt: new Date().toISOString()},
    company: {
      name:"", org:"",
      fyStart:`${y}-01-01`,
      fyEnd:`${y}-12-31`,
      defaultSeries:"A",
      nextVoucher: 1,
      lockUntil: ""
    },
    accounts: [],
    vouchers: [],
    seriesNext: {},
    audit: []
  };
}
let db = defaultDB();
let saveTimer = null;

function logEvent(action, detail){
  db.audit = db.audit || [];
  db.audit.unshift({ts: new Date().toISOString(), action, detail});
  if(db.audit.length > 2000) db.audit.length = 2000;
}
function scheduleSave(){
  if(saveTimer) clearTimeout(saveTimer);
  saveTimer = setTimeout(async ()=>{
    try{ await kvSave(JSON.stringify(db)); setStatus("Sparat","ok"); }
    catch(e){ console.error(e); setStatus("Kunde inte spara.","err"); }
  }, 180);
}
async function loadOrInitDB(){
  const raw = await kvLoad();
  if(raw){
    try{
      db = JSON.parse(raw);
      if(!db.meta) db.meta = {version:2};
      if(!db.audit) db.audit = [];
      return;
    }catch(e){ console.error(e); }
  }
  const v1 = localStorage.getItem(V1_KEY);
  if(v1){
    try{
      const old = JSON.parse(v1);
      db = defaultDB();
      if(old.company){
        db.company.name = old.company.name || "";
        db.company.org = old.company.org || "";
        db.company.fyStart = old.company.fyStart || db.company.fyStart;
        db.company.fyEnd = old.company.fyEnd || db.company.fyEnd;
        db.company.defaultSeries = old.company.defaultSeries || "A";
        db.company.nextVoucher = old.company.nextVoucher || 1;
      }
      db.accounts = Array.isArray(old.accounts)? old.accounts : [];
      db.vouchers = Array.isArray(old.vouchers)? old.vouchers : [];
      db.seriesNext = old.seriesNext || {};
      logEvent("migrate", "Importerade data från v1 localStorage.");
      await kvSave(JSON.stringify(db));
      setStatus("Migrerad från v1.","ok");
      return;
    }catch(e){ console.warn("V1 migration failed", e); }
  }
  db = defaultDB();
  await kvSave(JSON.stringify(db));
}

function nowISODate(){
  const d = new Date();
  const pad=(n)=>String(n).padStart(2,'0');
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
}
function toNumber(v){
  if(v===null || v===undefined || v==="") return 0;
  const n = Number(String(v).replace(",", "."));
  return isFinite(n) ? n : 0;
}
function money(n){ return (Math.round((n+Number.EPSILON)*100)/100).toFixed(2); }
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
}
function escapeAttr(s){ return escapeHtml(s).replaceAll("\n"," "); }
function typeLabel(t){
  return t==="asset"?"Tillgång"
    : t==="liability"?"Skuld"
    : t==="equity"?"Eget kapital"
    : t==="revenue"?"Intäkt"
    : t==="expense"?"Kostnad"
    : String(t||"");
}
function sumVoucher(v){
  const sumD = (v.lines||[]).reduce((s,l)=>s+toNumber(l.debit),0);
  const sumC = (v.lines||[]).reduce((s,l)=>s+toNumber(l.credit),0);
  return {debit:sumD, credit:sumC, diff:sumD-sumC};
}
function withinLock(date){
  const lock = db.company.lockUntil;
  return lock && date && date <= lock;
}
function assertNotLocked(date){
  if(withinLock(date)) throw new Error(`Period låst t.o.m. ${db.company.lockUntil}. Du försöker bokföra ${date}.`);
}
function downloadText(filename, text, mime="text/plain;charset=utf-8"){
  const blob = new Blob([text], {type:mime});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename;
  document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 1500);
}

function showTab(name){
  document.querySelectorAll("nav button").forEach(b=>b.classList.toggle("active", b.dataset.tab===name));
  document.querySelectorAll("main section[id^='tab-']").forEach(s=>s.classList.add("hidden"));
  $("tab-"+name).classList.remove("hidden");
  if(name==="start") renderStart();
  if(name==="foretag") renderCompany();
  if(name==="kontoplan") renderAccounts();
  if(name==="verifikat") renderVouchers();
  if(name==="rapporter") renderReports();
  if(name==="importexport") renderImportExport();
  if(name==="logg") renderLog();
}
$("tabs").addEventListener("click",(e)=>{
  const btn = e.target.closest("button[data-tab]");
  if(btn) showTab(btn.dataset.tab);
});

function basMinimalAccounts(){
  return [
    {no:"1930", name:"Företagskonto / bank", type:"asset", vat:"NONE"},
    {no:"1910", name:"Kassa", type:"asset", vat:"NONE"},
    {no:"1510", name:"Kundfordringar", type:"asset", vat:"NONE"},
    {no:"2440", name:"Leverantörsskulder", type:"liability", vat:"NONE"},
    {no:"2010", name:"Eget kapital", type:"equity", vat:"NONE"},
    {no:"2018", name:"Egna insättningar", type:"equity", vat:"NONE"},
    {no:"3010", name:"Försäljning", type:"revenue", vat:"NONE"},
    {no:"2611", name:"Utgående moms 25%", type:"liability", vat:"OUT25"},
    {no:"2621", name:"Utgående moms 12%", type:"liability", vat:"OUT12"},
    {no:"2631", name:"Utgående moms 6%", type:"liability", vat:"OUT6"},
    {no:"2641", name:"Ingående moms 25%", type:"asset", vat:"IN25"},
    {no:"2645", name:"Ingående moms 12%", type:"asset", vat:"IN12"},
    {no:"2647", name:"Ingående moms 6%", type:"asset", vat:"IN6"},
    {no:"4010", name:"Varuinköp", type:"expense", vat:"NONE"},
    {no:"5460", name:"Förbrukningsmaterial", type:"expense", vat:"NONE"},
    {no:"6071", name:"Representation, avdragsgill", type:"expense", vat:"NONE"},
  ];
}
function guessTypeFromBAS(no){
  const n = Number(no);
  if(n>=1000 && n<2000) return "asset";
  if(n>=2000 && n<3000) return "liability";
  if(n>=3000 && n<4000) return "revenue";
  if(n>=4000 && n<9000) return "expense";
  return "asset";
}
function guessVatFromBAS(no){
  const n = Number(no);
  if(n===2611) return "OUT25";
  if(n===2621) return "OUT12";
  if(n===2631) return "OUT6";
  if(n===2641) return "IN25";
  if(n===2645) return "IN12";
  if(n===2647) return "IN6";
  return "NONE";
}

function renderStart(){
  const c = db.company || {};
  const totalAcc = db.accounts.length;
  const totalV = db.vouchers.length;
  const fy = (c.fyStart && c.fyEnd) ? `${c.fyStart} → ${c.fyEnd}` : "—";
  $("overview").innerHTML = `
    <div>Företag</div><div>${escapeHtml(c.name || "—")}</div>
    <div>Org.nr</div><div>${escapeHtml(c.org || "—")}</div>
    <div>Räkenskapsår</div><div>${escapeHtml(fy)}</div>
    <div>Periodlås</div><div>${escapeHtml(c.lockUntil || "—")}</div>
    <div>Konton</div><div>${totalAcc}</div>
    <div>Verifikat</div><div>${totalV}</div>
    <div>Standardserie</div><div>${escapeHtml(c.defaultSeries || "A")}</div>
  `;
  const issues = [];
  if(!c.name) issues.push("Saknar företagsnamn.");
  if(!c.fyStart || !c.fyEnd) issues.push("Saknar räkenskapsår.");
  if(totalAcc===0) issues.push("Kontoplan saknas.");
  const unbal = db.vouchers.filter(v=>Math.abs(sumVoucher(v).diff) > 0.00001);
  if(unbal.length) issues.push(`Det finns ${unbal.length} obalanserade verifikat (bör vara 0).`);
  const lockedInData = c.lockUntil ? db.vouchers.filter(v=>v.date<=c.lockUntil).length : 0;
  $("quickChecks").innerHTML = issues.length
    ? `<div class="err">⚠ ${issues.map(escapeHtml).join("<br>")}</div>`
    : `<div class="oktxt">✓ Ser bra ut.</div>` +
      (c.lockUntil ? `<div class="muted" style="margin-top:8px">Låst t.o.m. ${escapeHtml(c.lockUntil)} (verifikat i låst period: ${lockedInData}).</div>` : "");
}
$("btnPrefill").addEventListener("click", ()=>{
  if(db.accounts.length){ setStatus("Kontoplan finns redan.","err"); return; }
  db.accounts = basMinimalAccounts();
  logEvent("accounts.prefill", "Skapade BAS-minimal kontoplan.");
  scheduleSave();
  setStatus("BAS-minimal kontoplan skapad.","ok");
  renderStart();
});
function suggestNextNo(series){
  series = (series||"A").toUpperCase();
  const next = (db.seriesNext && db.seriesNext[series]) ? db.seriesNext[series] : null;
  if(next) return next;
  const max = db.vouchers.filter(v=>String(v.series).toUpperCase()===series).reduce((m,v)=>Math.max(m, Number(v.no||0)), 0);
  return max>0 ? (max+1) : (db.company.nextVoucher||1);
}
function addVoucher({date,series,no,text,lines}){
  series = (series||"A").toUpperCase();
  const usedNo = no ?? suggestNextNo(series);
  db.vouchers.push({ id: crypto.randomUUID(), date, series, no: usedNo, text, lines });
  db.seriesNext = db.seriesNext || {};
  db.seriesNext[series] = Math.max(usedNo+1, db.seriesNext[series]||1);
}
$("btnDemo").addEventListener("click", ()=>{
  if(db.accounts.length===0) db.accounts = basMinimalAccounts();
  const today = nowISODate();
  try{ assertNotLocked(today); }catch(e){ setStatus(e.message,"err"); return; }
  addVoucher({ date: today, series: (db.company.defaultSeries||"A"), no:null, text:"Insättning på bank",
    lines:[ {account:"1930",debit:10000,credit:0}, {account:"2018",debit:0,credit:10000} ]});
  addVoucher({ date: today, series: (db.company.defaultSeries||"A"), no:null, text:"Inköp förbrukningsmaterial inkl moms 25%",
    lines:[ {account:"5460",debit:800,credit:0}, {account:"2641",debit:200,credit:0}, {account:"1930",debit:0,credit:1000} ]});
  logEvent("vouchers.demo", "Skapade 2 demo-verifikat.");
  scheduleSave();
  setStatus("Demo-verifikat skapade.","ok");
  renderStart();
});
$("btnReset").addEventListener("click", async ()=>{
  if(!confirm("Radera ALL data i den här appen?")) return;
  await kvReset();
  db = defaultDB();
  await kvSave(JSON.stringify(db));
  setStatus("All data raderad.","ok");
  showTab("start");
});
$("btnBackupFile").addEventListener("click", ()=>{
  downloadText("bokforing-backup.json", JSON.stringify(db,null,2), "application/json;charset=utf-8");
  logEvent("export.json", "Exporterade JSON-backup (fil).");
  scheduleSave();
});
$("btnSIEFile").addEventListener("click", ()=>{
  downloadText("bokforing.sie", generateSIE(db), "text/plain;charset=utf-8");
  logEvent("export.sie", "Exporterade SIE (fil).");
  scheduleSave();
});
$("btnPrintStart").addEventListener("click", ()=>window.print());

function renderCompany(){
  const c = db.company;
  $("cName").value = c.name || "";
  $("cOrg").value = c.org || "";
  $("fyStart").value = c.fyStart || "";
  $("fyEnd").value = c.fyEnd || "";
  $("defaultSeries").value = c.defaultSeries || "A";
  $("nextVoucher").value = c.nextVoucher || 1;
  $("lockUntil").value = c.lockUntil || "";
  $("lockInfo").textContent = c.lockUntil ? `Låst t.o.m. ${c.lockUntil}` : "Ingen låsning";
  $("companyMsg").textContent = "";
}
$("btnSaveCompany").addEventListener("click", ()=>{
  db.company.name = $("cName").value.trim();
  db.company.org = $("cOrg").value.trim();
  db.company.fyStart = $("fyStart").value;
  db.company.fyEnd = $("fyEnd").value;
  db.company.defaultSeries = ($("defaultSeries").value.trim() || "A").toUpperCase();
  db.company.nextVoucher = Math.max(1, parseInt($("nextVoucher").value || "1", 10));
  db.company.lockUntil = $("lockUntil").value || "";
  $("lockInfo").textContent = db.company.lockUntil ? `Låst t.o.m. ${db.company.lockUntil}` : "Ingen låsning";
  logEvent("company.update", "Uppdaterade företagsinställningar.");
  scheduleSave();
  $("companyMsg").textContent = "Sparat.";
  setStatus("Företag sparat.","ok");
  renderStart();
});
$("btnUnlock").addEventListener("click", ()=>{
  db.company.lockUntil = "";
  $("lockUntil").value = "";
  $("lockInfo").textContent = "Ingen låsning";
  logEvent("company.unlock", "Tog bort periodlås.");
  scheduleSave();
  setStatus("Upplåst.","ok");
});

let selectedAccountNo = null;
function renderAccounts(){
  const q = ($("accSearch").value||"").trim().toLowerCase();
  const rows = [...db.accounts].filter(a=>{
    if(!q) return true;
    return String(a.no).includes(q) || (a.name||"").toLowerCase().includes(q);
  }).sort((a,b)=>String(a.no).localeCompare(String(b.no), "sv"));
  $("accTable").innerHTML = rows.map(a=>`
    <tr data-no="${escapeAttr(a.no)}" style="cursor:pointer">
      <td class="mono">${escapeHtml(a.no)}</td>
      <td>${escapeHtml(a.name||"")}</td>
      <td>${typeLabel(a.type)}</td>
      <td class="mono">${escapeHtml(a.vat||"NONE")}</td>
    </tr>
  `).join("") || `<tr><td colspan="4" class="muted">Inga konton.</td></tr>`;
  $("accMsg").textContent = selectedAccountNo ? `Valt konto: ${selectedAccountNo}` : "";
}
$("accSearch").addEventListener("input", renderAccounts);
$("btnAccSort").addEventListener("click", renderAccounts);
$("accTable").addEventListener("click",(e)=>{
  const tr = e.target.closest("tr[data-no]");
  if(!tr) return;
  const no = tr.dataset.no;
  const a = db.accounts.find(x=>String(x.no)===String(no));
  if(!a) return;
  selectedAccountNo = String(a.no);
  $("accNo").value = a.no;
  $("accName").value = a.name || "";
  $("accType").value = a.type || "asset";
  $("accVAT").value = a.vat || "NONE";
  $("accMsg").textContent = `Laddat konto ${a.no}.`;
});
$("btnAccClear").addEventListener("click", ()=>{
  selectedAccountNo = null;
  $("accNo").value = "";
  $("accName").value = "";
  $("accType").value = "asset";
  $("accVAT").value = "NONE";
  $("accMsg").textContent = "";
});
$("btnAccSave").addEventListener("click", ()=>{
  const no = $("accNo").value.trim();
  const name = $("accName").value.trim();
  const type = $("accType").value;
  const vat = $("accVAT").value;
  if(!/^\d{3,4}$/.test(no)){ $("accMsg").innerHTML = `<span class="err">Konto måste vara 3–4 siffror.</span>`; setStatus("Fel i konto.","err"); return; }
  if(!name){ $("accMsg").innerHTML = `<span class="err">Namn krävs.</span>`; setStatus("Fel i konto.","err"); return; }
  const existing = db.accounts.find(a=>String(a.no)===String(no));
  if(existing){
    existing.name = name; existing.type = type; existing.vat = vat;
    selectedAccountNo = String(no);
    $("accMsg").textContent = `Uppdaterat konto ${no}.`;
    logEvent("account.update", `Uppdaterade konto ${no}.`);
  }else{
    db.accounts.push({no, name, type, vat});
    selectedAccountNo = String(no);
    $("accMsg").textContent = `Skapat konto ${no}.`;
    logEvent("account.create", `Skapade konto ${no}.`);
  }
  scheduleSave();
  setStatus("Konto sparat.","ok");
  renderAccounts();
});
$("btnAccDelete").addEventListener("click", ()=>{
  const no = ($("accNo").value||"").trim();
  if(!no) return;
  const used = db.vouchers.some(v=>v.lines.some(l=>String(l.account)===String(no)));
  if(used && !confirm("Kontot används i verifikat. Ta bort ändå?")) return;
  db.accounts = db.accounts.filter(a=>String(a.no)!==String(no));
  if(selectedAccountNo===String(no)) selectedAccountNo=null;
  logEvent("account.delete", `Tog bort konto ${no}.`);
  scheduleSave();
  setStatus("Konto borttaget.","ok");
  renderAccounts();
});

let loadedVoucherId = null;
function newLineRow(line = {account:"",debit:0,credit:0}){
  const div = document.createElement("div");
  div.className = "row";
  div.style.marginTop = "10px";
  div.innerHTML = `
    <div style="flex:1;min-width:160px">
      <label>Konto</label>
      <input class="lineAccount" placeholder="1930" value="${escapeAttr(line.account||"")}" />
    </div>
    <div style="flex:1;min-width:160px">
      <label>Debet</label>
      <input class="lineDebit" placeholder="0.00" value="${escapeAttr(line.debit? money(line.debit): "")}" />
    </div>
    <div style="flex:1;min-width:160px">
      <label>Kredit</label>
      <input class="lineCredit" placeholder="0.00" value="${escapeAttr(line.credit? money(line.credit): "")}" />
    </div>
    <div style="flex:0;min-width:90px;display:flex;align-items:flex-end">
      <button class="btn danger btnRemoveLine" title="Ta bort rad">Ta bort</button>
    </div>
  `;
  div.querySelectorAll("input").forEach(inp=>inp.addEventListener("input", updateVoucherSums));
  div.querySelector(".btnRemoveLine").addEventListener("click", ()=>{ div.remove(); updateVoucherSums(); });
  return div;
}
function readLinesFromUI(){
  const lines = [];
  document.querySelectorAll("#lines .row").forEach(r=>{
    const account = r.querySelector(".lineAccount").value.trim();
    const debit = toNumber(r.querySelector(".lineDebit").value.trim());
    const credit = toNumber(r.querySelector(".lineCredit").value.trim());
    if(!account && debit===0 && credit===0) return;
    lines.push({account, debit, credit});
  });
  return lines;
}
function updateVoucherSums(){
  const lines = readLinesFromUI();
  const sumD = lines.reduce((s,l)=>s+toNumber(l.debit),0);
  const sumC = lines.reduce((s,l)=>s+toNumber(l.credit),0);
  const diff = sumD - sumC;
  $("sumDebit").textContent = money(sumD);
  $("sumCredit").textContent = money(sumC);
  $("sumDiff").textContent = money(diff);
  $("sumDiff").style.color = Math.abs(diff) < 0.00001 ? "var(--ok)" : "var(--danger)";
}
function refreshVoucherList(){
  const from = $("listFrom").value || "0000-01-01";
  const to = $("listTo").value || "9999-12-31";
  const q = ($("voucherSearch").value||"").trim().toLowerCase();
  const rows = [...db.vouchers].filter(v=>v.date>=from && v.date<=to).filter(v=>{
    if(!q) return true;
    const key = `${v.series}${v.no}`.toLowerCase();
    return key.includes(q) || (v.text||"").toLowerCase().includes(q);
  }).sort((a,b)=>{
    if(a.date!==b.date) return a.date.localeCompare(b.date);
    const as = String(a.series).localeCompare(String(b.series), "sv");
    if(as!==0) return as;
    return Number(a.no)-Number(b.no);
  });
  $("voucherTable").innerHTML = rows.map(v=>`
    <tr data-id="${escapeAttr(v.id)}" style="cursor:pointer">
      <td class="mono">${escapeHtml(v.date)}</td>
      <td class="mono">${escapeHtml(v.series)}</td>
      <td class="mono">${escapeHtml(String(v.no))}</td>
      <td>${escapeHtml(v.text||"")}</td>
      <td class="num">${v.lines.length}</td>
    </tr>
  `).join("") || `<tr><td colspan="5" class="muted">Inga verifikat i perioden.</td></tr>`;
}
function renderVouchers(){
  if(!$("vDate").value) $("vDate").value = nowISODate();
  if(!$("vSeries").value) $("vSeries").value = (db.company.defaultSeries||"A");
  if(!$("vNo").value) $("vNo").value = suggestNextNo($("vSeries").value);
  if($("lines").children.length===0){
    $("lines").appendChild(newLineRow());
    $("lines").appendChild(newLineRow());
  }
  updateVoucherSums();
  const c = db.company;
  $("listFrom").value = $("listFrom").value || c.fyStart || "";
  $("listTo").value = $("listTo").value || c.fyEnd || "";
  refreshVoucherList();
}
$("btnAddLine").addEventListener("click", ()=>{ $("lines").appendChild(newLineRow()); updateVoucherSums(); });
$("vSeries").addEventListener("input", ()=>{ const s = ($("vSeries").value||"A").toUpperCase(); $("vSeries").value=s; $("vNo").value=suggestNextNo(s); });
$("btnClearVoucher").addEventListener("click", ()=>{
  loadedVoucherId = null;
  $("vDate").value = nowISODate();
  $("vSeries").value = (db.company.defaultSeries||"A");
  $("vNo").value = suggestNextNo($("vSeries").value);
  $("vText").value = "";
  $("lines").innerHTML = "";
  $("lines").appendChild(newLineRow());
  $("lines").appendChild(newLineRow());
  $("voucherMsg").textContent = "";
  updateVoucherSums();
  setStatus("Formulär rensat.","ok");
});
$("btnSaveVoucher").addEventListener("click", ()=>{
  const date = $("vDate").value;
  const series = ($("vSeries").value||"A").trim().toUpperCase();
  const no = parseInt($("vNo").value || "0", 10);
  const text = ($("vText").value||"").trim();
  const lines = readLinesFromUI();
  try{
    if(!date) throw new Error("Datum krävs.");
    assertNotLocked(date);
    if(!series) throw new Error("Serie krävs.");
    if(!no || no<1) throw new Error("Ver.nr måste vara >= 1.");
    if(lines.length<2) throw new Error("Minst 2 rader krävs.");
    const missing = lines.map(l=>l.account).filter(a=>a && !db.accounts.some(x=>String(x.no)===String(a)));
    if(missing.length) throw new Error("Okända konton: " + missing.join(", "));
    const sums = sumVoucher({lines});
    if(Math.abs(sums.diff) > 0.00001) throw new Error(`Verifikatet balanserar inte (diff ${money(sums.diff)}).`);
    const dup = db.vouchers.find(v=>v.id!==loadedVoucherId && String(v.series).toUpperCase()===series && Number(v.no)===no);
    if(dup) throw new Error(`Ver.nr ${series}${no} finns redan.`);
    if(loadedVoucherId){
      const v = db.vouchers.find(x=>x.id===loadedVoucherId);
      if(!v) throw new Error("Kunde inte hitta laddat verifikat.");
      v.date=date; v.series=series; v.no=no; v.text=text; v.lines=lines;
      $("voucherMsg").textContent = `Uppdaterat ${series}${no}.`;
      logEvent("voucher.update", `Uppdaterade ${series}${no} (${date}).`);
    }else{
      db.vouchers.push({id: crypto.randomUUID(), date, series, no, text, lines});
      $("voucherMsg").textContent = `Sparat ${series}${no}.`;
      logEvent("voucher.create", `Skapade ${series}${no} (${date}).`);
    }
    db.seriesNext = db.seriesNext || {};
    db.seriesNext[series] = Math.max(no+1, db.seriesNext[series]||1);
    scheduleSave();
    setStatus("Verifikat sparat.","ok");
    refreshVoucherList();
    renderStart();
  }catch(e){
    $("voucherMsg").innerHTML = `<span class="err">${escapeHtml(e.message || String(e))}</span>`;
    setStatus("Fel i verifikat.","err");
  }
});
$("btnDeleteVoucher").addEventListener("click", ()=>{
  if(!loadedVoucherId) return;
  const v = db.vouchers.find(x=>x.id===loadedVoucherId);
  if(!v) return;
  try{ assertNotLocked(v.date); }catch(e){ $("voucherMsg").innerHTML = `<span class="err">${escapeHtml(e.message)}</span>`; setStatus("Låst period.","err"); return; }
  if(!confirm("Ta bort detta verifikat?")) return;
  db.vouchers = db.vouchers.filter(x=>x.id!==loadedVoucherId);
  logEvent("voucher.delete", `Tog bort ${v.series}${v.no} (${v.date}).`);
  loadedVoucherId = null;
  scheduleSave();
  setStatus("Verifikat borttaget.","ok");
  $("btnClearVoucher").click();
  refreshVoucherList();
  renderStart();
});
$("btnRefreshList").addEventListener("click", refreshVoucherList);
$("voucherSearch").addEventListener("input", refreshVoucherList);
$("voucherTable").addEventListener("click",(e)=>{
  const tr = e.target.closest("tr[data-id]");
  if(!tr) return;
  const id = tr.dataset.id;
  const v = db.vouchers.find(x=>x.id===id);
  if(!v) return;
  loadedVoucherId = v.id;
  $("vDate").value = v.date;
  $("vSeries").value = String(v.series).toUpperCase();
  $("vNo").value = v.no;
  $("vText").value = v.text || "";
  $("lines").innerHTML = "";
  v.lines.forEach(l=>$("lines").appendChild(newLineRow(l)));
  updateVoucherSums();
  $("voucherMsg").textContent = `Laddat ${v.series}${v.no}.`;
  setStatus(withinLock(v.date) ? `Laddat (låst t.o.m. ${db.company.lockUntil})` : "Verifikat laddat.", withinLock(v.date) ? "err" : "ok");
});

function renderReports(){
  const c = db.company;
  $("rFrom").value = $("rFrom").value || c.fyStart || "";
  $("rTo").value = $("rTo").value || c.fyEnd || "";
  $("reportOut").innerHTML = "—";
  $("reportText").classList.add("hidden");
  $("reportMsg").textContent = "";
}
$("rType").addEventListener("change", ()=>{
  $("ledgerAccountWrap").classList.toggle("hidden", $("rType").value!=="ledger");
});
$("btnPrintReport").addEventListener("click", ()=>window.print());
function postedLines(from,to){
  const res = [];
  for(const v of db.vouchers){
    if(v.date < from || v.date > to) continue;
    for(const l of v.lines){
      res.push({ date:v.date, series:v.series, no:v.no, text:v.text||"", account:l.account, debit:toNumber(l.debit), credit:toNumber(l.credit) });
    }
  }
  return res;
}
function accountMap(){ const m=new Map(); for(const a of db.accounts) m.set(String(a.no), a); return m; }
function reportTrial(from,to){
  const lines = postedLines(from,to);
  const amap = accountMap();
  const sums = new Map();
  for(const l of lines){
    if(!sums.has(l.account)) sums.set(l.account, {debit:0,credit:0});
    const s = sums.get(l.account);
    s.debit += l.debit; s.credit += l.credit;
  }
  const rows = [...sums.entries()].map(([acc,s])=>{
    const a = amap.get(String(acc)) || {name:"(saknas)", type:"", vat:""};
    const balance = s.debit - s.credit;
    return {acc, name:a.name, type:a.type, debit:s.debit, credit:s.credit, balance};
  }).sort((x,y)=>String(x.acc).localeCompare(String(y.acc), "sv"));
  const totalD = rows.reduce((p,r)=>p+r.debit,0);
  const totalC = rows.reduce((p,r)=>p+r.credit,0);
  const html = `
    <div class="muted small">Saldolista ${escapeHtml(from)} → ${escapeHtml(to)}</div>
    <div class="sep"></div>
    <table>
      <thead><tr><th>Konto</th><th>Namn</th><th class="num">Debet</th><th class="num">Kredit</th><th class="num">Saldo</th></tr></thead>
      <tbody>
        ${rows.map(r=>`
          <tr>
            <td class="mono">${escapeHtml(r.acc)}</td>
            <td>${escapeHtml(r.name||"")}</td>
            <td class="num mono">${money(r.debit)}</td>
            <td class="num mono">${money(r.credit)}</td>
            <td class="num mono">${money(r.balance)}</td>
          </tr>
        `).join("")}
        <tr>
          <td colspan="2" class="muted">Summa</td>
          <td class="num mono">${money(totalD)}</td>
          <td class="num mono">${money(totalC)}</td>
          <td class="num mono">${money(totalD-totalC)}</td>
        </tr>
      </tbody>
    </table>
  `;
  const text = [
    `SALDOLISTA ${from} - ${to}`,
    `Konto\tNamn\tDebet\tKredit\tSaldo`,
    ...rows.map(r=>`${r.acc}\t${r.name}\t${money(r.debit)}\t${money(r.credit)}\t${money(r.balance)}`),
    `SUMMA\t\t${money(totalD)}\t${money(totalC)}\t${money(totalD-totalC)}`
  ].join("\n");
  return {html, text};
}
function reportLedger(acc, from,to){
  if(!acc) throw new Error("Ange konto för huvudbok.");
  const amap = accountMap();
  const a = amap.get(String(acc));
  if(!a) throw new Error("Okänt konto.");
  const lines = postedLines(from,to).filter(l=>String(l.account)===String(acc))
    .sort((x,y)=>{
      if(x.date!==y.date) return x.date.localeCompare(y.date);
      if(x.series!==y.series) return String(x.series).localeCompare(String(y.series),"sv");
      return Number(x.no)-Number(y.no);
    });
  let run = 0;
  const rows = lines.map(l=>{ const delta = l.debit - l.credit; run += delta; return {...l, saldo:run}; });
  const html = `
    <div class="muted small">Huvudbok konto <span class="mono">${escapeHtml(acc)}</span> – ${escapeHtml(a.name||"")}, ${escapeHtml(from)} → ${escapeHtml(to)}</div>
    <div class="sep"></div>
    <table>
      <thead><tr><th>Datum</th><th>Ver</th><th>Text</th><th class="num">Debet</th><th class="num">Kredit</th><th class="num">Saldo</th></tr></thead>
      <tbody>
        ${rows.map(r=>`
          <tr>
            <td class="mono">${escapeHtml(r.date)}</td>
            <td class="mono">${escapeHtml(r.series)}${escapeHtml(String(r.no))}</td>
            <td>${escapeHtml(r.text||"")}</td>
            <td class="num mono">${money(r.debit)}</td>
            <td class="num mono">${money(r.credit)}</td>
            <td class="num mono">${money(r.saldo)}</td>
          </tr>
        `).join("") || `<tr><td colspan="6" class="muted">Inga transaktioner.</td></tr>`}
      </tbody>
    </table>
  `;
  const text = [
    `HUVUDBOK ${acc} ${a.name} ${from}-${to}`,
    `Datum\tVer\tText\tDebet\tKredit\tSaldo`,
    ...rows.map(r=>`${r.date}\t${r.series}${r.no}\t${r.text}\t${money(r.debit)}\t${money(r.credit)}\t${money(r.saldo)}`)
  ].join("\n");
  return {html, text};
}
function reportPL(from,to){
  const lines = postedLines(from,to);
  const amap = accountMap();
  const sums = new Map();
  for(const l of lines){
    const a = amap.get(String(l.account));
    if(!a) continue;
    if(a.type!=="revenue" && a.type!=="expense") continue;
    if(!sums.has(l.account)) sums.set(l.account, 0);
    sums.set(l.account, sums.get(l.account) + (l.debit - l.credit));
  }
  const rows = [...sums.entries()].map(([acc,balance])=>{
    const a = amap.get(String(acc));
    let amount = balance;
    if(a.type==="revenue") amount = -balance;
    return {acc, name:a.name, type:a.type, amount};
  }).sort((x,y)=>String(x.acc).localeCompare(String(y.acc),"sv"));
  const rev = rows.filter(r=>r.type==="revenue").reduce((s,r)=>s+r.amount,0);
  const exp = rows.filter(r=>r.type==="expense").reduce((s,r)=>s+r.amount,0);
  const result = rev - exp;
  const html = `
    <div class="muted small">Resultaträkning ${escapeHtml(from)} → ${escapeHtml(to)}</div>
    <div class="sep"></div>
    <table>
      <thead><tr><th>Konto</th><th>Namn</th><th>Typ</th><th class="num">Belopp</th></tr></thead>
      <tbody>
        ${rows.map(r=>`
          <tr>
            <td class="mono">${escapeHtml(r.acc)}</td>
            <td>${escapeHtml(r.name||"")}</td>
            <td>${r.type==="revenue"?"Intäkt":"Kostnad"}</td>
            <td class="num mono">${money(r.amount)}</td>
          </tr>
        `).join("") || `<tr><td colspan="4" class="muted">Inga resultatkonton i perioden.</td></tr>`}
        <tr><td colspan="3" class="muted">Summa intäkter</td><td class="num mono">${money(rev)}</td></tr>
        <tr><td colspan="3" class="muted">Summa kostnader</td><td class="num mono">${money(exp)}</td></tr>
        <tr><td colspan="3" class="muted">Periodens resultat</td><td class="num mono">${money(result)}</td></tr>
      </tbody>
    </table>
  `;
  const text = [
    `RESULTATRÄKNING ${from}-${to}`,
    `Konto\tNamn\tTyp\tBelopp`,
    ...rows.map(r=>`${r.acc}\t${r.name}\t${r.type}\t${money(r.amount)}`),
    `SUM INTÄKTER\t\t\t${money(rev)}`,
    `SUM KOSTNADER\t\t\t${money(exp)}`,
    `RESULTAT\t\t\t${money(result)}`
  ].join("\n");
  return {html, text};
}
function reportBS(from,to){
  const lines = postedLines(from,to);
  const amap = accountMap();
  const sums = new Map();
  for(const l of lines){
    const a = amap.get(String(l.account));
    if(!a) continue;
    if(!["asset","liability","equity"].includes(a.type)) continue;
    if(!sums.has(l.account)) sums.set(l.account, 0);
    sums.set(l.account, sums.get(l.account) + (l.debit - l.credit));
  }
  const rows = [...sums.entries()].map(([acc,balance])=>{
    const a = amap.get(String(acc));
    let amount = balance;
    if(a.type==="liability" || a.type==="equity") amount = -balance;
    return {acc, name:a.name, type:a.type, amount};
  }).sort((x,y)=>String(x.acc).localeCompare(String(y.acc),"sv"));
  const assets = rows.filter(r=>r.type==="asset").reduce((s,r)=>s+r.amount,0);
  const liab = rows.filter(r=>r.type==="liability").reduce((s,r)=>s+r.amount,0);
  const eq = rows.filter(r=>r.type==="equity").reduce((s,r)=>s+r.amount,0);
  const rhs = liab + eq;
  const diff = assets - rhs;
  const html = `
    <div class="muted small">Balansräkning ${escapeHtml(from)} → ${escapeHtml(to)}</div>
    <div class="sep"></div>
    <table>
      <thead><tr><th>Konto</th><th>Namn</th><th>Typ</th><th class="num">Belopp</th></tr></thead>
      <tbody>
        ${rows.map(r=>`
          <tr>
            <td class="mono">${escapeHtml(r.acc)}</td>
            <td>${escapeHtml(r.name||"")}</td>
            <td>${typeLabel(r.type)}</td>
            <td class="num mono">${money(r.amount)}</td>
          </tr>
        `).join("") || `<tr><td colspan="4" class="muted">Inga balanskonton i perioden.</td></tr>`}
        <tr><td colspan="3" class="muted">Summa tillgångar</td><td class="num mono">${money(assets)}</td></tr>
        <tr><td colspan="3" class="muted">Summa skulder</td><td class="num mono">${money(liab)}</td></tr>
        <tr><td colspan="3" class="muted">Summa eget kapital</td><td class="num mono">${money(eq)}</td></tr>
        <tr><td colspan="3" class="muted">Diff (ska vara 0)</td><td class="num mono">${money(diff)}</td></tr>
      </tbody>
    </table>
  `;
  const text = [
    `BALANSRÄKNING ${from}-${to}`,
    `Konto\tNamn\tTyp\tBelopp`,
    ...rows.map(r=>`${r.acc}\t${r.name}\t${r.type}\t${money(r.amount)}`),
    `SUM TILLGÅNGAR\t\t\t${money(assets)}`,
    `SUM SKULDER\t\t\t${money(liab)}`,
    `SUM EGET KAPITAL\t\t\t${money(eq)}`,
    `DIFF\t\t\t${money(diff)}`
  ].join("\n");
  return {html, text};
}
function reportVAT2(from,to){
  const lines = postedLines(from,to);
  const amap = accountMap();
  const vatCodes = ["OUT25","OUT12","OUT6","IN25","IN12","IN6"];
  const perCode = Object.fromEntries(vatCodes.map(c=>[c,0]));
  const accAgg = new Map();
  for(const l of lines){
    const a = amap.get(String(l.account));
    if(!a) continue;
    if(!vatCodes.includes(a.vat)) continue;
    if(!accAgg.has(l.account)) accAgg.set(l.account, {debit:0,credit:0,vat:a.vat,name:a.name});
    const s = accAgg.get(l.account);
    s.debit += l.debit; s.credit += l.credit;
  }
  const perAcc = [];
  for(const [acc,s] of accAgg.entries()){
    let amount = 0;
    if(String(s.vat).startsWith("OUT")) amount = (s.credit - s.debit);
    else amount = (s.debit - s.credit);
    perCode[s.vat] += amount;
    perAcc.push({acc, name:s.name, vat:s.vat, amount});
  }
  perAcc.sort((a,b)=>String(a.acc).localeCompare(String(b.acc),"sv"));
  const out = perCode.OUT25 + perCode.OUT12 + perCode.OUT6;
  const inn = perCode.IN25 + perCode.IN12 + perCode.IN6;
  const payable = out - inn;
  const html = `
    <div class="muted small">Momsrapport (v2) ${escapeHtml(from)} → ${escapeHtml(to)}</div>
    <div class="sep"></div>
    <div class="row">
      <div class="pill">Utgående 25%: <span class="mono">${money(perCode.OUT25)}</span></div>
      <div class="pill">Utgående 12%: <span class="mono">${money(perCode.OUT12)}</span></div>
      <div class="pill">Utgående 6%: <span class="mono">${money(perCode.OUT6)}</span></div>
    </div>
    <div class="row" style="margin-top:8px">
      <div class="pill">Ingående 25%: <span class="mono">${money(perCode.IN25)}</span></div>
      <div class="pill">Ingående 12%: <span class="mono">${money(perCode.IN12)}</span></div>
      <div class="pill">Ingående 6%: <span class="mono">${money(perCode.IN6)}</span></div>
    </div>
    <div class="sep"></div>
    <table>
      <thead><tr><th>Konto</th><th>Namn</th><th>Moms</th><th class="num">Belopp</th></tr></thead>
      <tbody>
        ${perAcc.map(r=>`
          <tr>
            <td class="mono">${escapeHtml(r.acc)}</td>
            <td>${escapeHtml(r.name||"")}</td>
            <td class="mono">${escapeHtml(r.vat)}</td>
            <td class="num mono">${money(r.amount)}</td>
          </tr>
        `).join("") || `<tr><td colspan="4" class="muted">Inga momskonton i perioden.</td></tr>`}
        <tr><td colspan="3" class="muted">Summa utgående</td><td class="num mono">${money(out)}</td></tr>
        <tr><td colspan="3" class="muted">Summa ingående</td><td class="num mono">${money(inn)}</td></tr>
        <tr><td colspan="3" class="muted">Moms att betala (+) / få tillbaka (-)</td><td class="num mono">${money(payable)}</td></tr>
      </tbody>
    </table>
  `;
  const text = [
    `MOMSRAPPORT (V2) ${from}-${to}`,
    `OUT25\t${money(perCode.OUT25)}`,
    `OUT12\t${money(perCode.OUT12)}`,
    `OUT6\t${money(perCode.OUT6)}`,
    `IN25\t${money(perCode.IN25)}`,
    `IN12\t${money(perCode.IN12)}`,
    `IN6\t${money(perCode.IN6)}`,
    `SUM OUT\t${money(out)}`,
    `SUM IN\t${money(inn)}`,
    `ATT BETALA(+)/FÅ(-)\t${money(payable)}`,
    ``,
    `DETALJER`,
    `Konto\tNamn\tKod\tBelopp`,
    ...perAcc.map(r=>`${r.acc}\t${r.name}\t${r.vat}\t${money(r.amount)}`)
  ].join("\n");
  return {html, text};
}
$("btnRunReport").addEventListener("click", ()=>{
  const from = $("rFrom").value || "0000-01-01";
  const to = $("rTo").value || "9999-12-31";
  const t = $("rType").value;
  let out="", text="";
  try{
    if(t==="trial") ({html:out, text} = reportTrial(from,to));
    else if(t==="ledger") ({html:out, text} = reportLedger(($("ledgerAccount").value||"").trim(), from,to));
    else if(t==="pl") ({html:out, text} = reportPL(from,to));
    else if(t==="bs") ({html:out, text} = reportBS(from,to));
    else if(t==="vat") ({html:out, text} = reportVAT2(from,to));
    $("reportOut").innerHTML = out;
    $("reportText").value = text;
    $("reportText").classList.remove("hidden");
    $("reportMsg").textContent = "Klar.";
    setStatus("Rapport klar.","ok");
  }catch(e){
    $("reportMsg").innerHTML = `<span class="err">${escapeHtml(String(e.message||e))}</span>`;
    setStatus("Rapportfel.","err");
  }
});
$("btnCopyReport").addEventListener("click", async ()=>{
  const t = $("reportText").value || "";
  if(!t) return;
  await navigator.clipboard.writeText(t);
  setStatus("Rapport kopierad.","ok");
});

function renderImportExport(){
  $("jsonOut").value = JSON.stringify(db, null, 2);
  $("sieOut").value = generateSIE(db);
  $("importMsg").textContent = "";
}
$("btnExportJSONFile").addEventListener("click", ()=>{
  downloadText("bokforing-backup.json", JSON.stringify(db,null,2), "application/json;charset=utf-8");
  logEvent("export.json", "Exporterade JSON-backup (fil).");
  scheduleSave();
});
$("btnExportJSONCopy").addEventListener("click", async ()=>{
  await navigator.clipboard.writeText(JSON.stringify(db,null,2));
  setStatus("JSON kopierad.","ok");
});
$("btnImportJSON").addEventListener("click", ()=>{
  try{
    const obj = JSON.parse($("jsonIn").value);
    if(!obj || typeof obj!=="object") throw new Error("Ogiltig JSON.");
    if(!obj.company || !Array.isArray(obj.accounts) || !Array.isArray(obj.vouchers)) throw new Error("Saknar obligatoriska fält.");
    db = obj; if(!db.audit) db.audit = [];
    logEvent("import.json", "Importerade JSON (text).");
    scheduleSave();
    $("importMsg").textContent = "Import klar.";
    setStatus("Import klar.","ok");
    showTab("start");
  }catch(e){
    $("importMsg").innerHTML = `<span class="err">${escapeHtml(String(e.message||e))}</span>`;
    setStatus("Importfel.","err");
  }
});
$("btnImportJSONFile").addEventListener("click", async ()=>{
  const f = $("jsonFile").files && $("jsonFile").files[0];
  if(!f) return;
  try{
    const obj = JSON.parse(await f.text());
    if(!obj || typeof obj!=="object") throw new Error("Ogiltig JSON.");
    if(!obj.company || !Array.isArray(obj.accounts) || !Array.isArray(obj.vouchers)) throw new Error("Saknar obligatoriska fält.");
    db = obj; if(!db.audit) db.audit = [];
    logEvent("import.json", `Importerade JSON-fil: ${f.name}`);
    scheduleSave();
    $("importMsg").textContent = "Import klar.";
    setStatus("Import klar.","ok");
    showTab("start");
  }catch(e){
    $("importMsg").innerHTML = `<span class="err">${escapeHtml(String(e.message||e))}</span>`;
    setStatus("Importfel.","err");
  }
});
$("btnExportSIEFile").addEventListener("click", ()=>{
  downloadText("bokforing.sie", generateSIE(db), "text/plain;charset=utf-8");
  logEvent("export.sie", "Exporterade SIE (fil).");
  scheduleSave();
});
$("btnCopySIE").addEventListener("click", async ()=>{
  await navigator.clipboard.writeText(generateSIE(db));
  setStatus("SIE kopierad.","ok");
});

function parseSieNumber(s){ return toNumber(String(s).replace(/\s/g,"")); }
function unquote(s){ let t=String(s||""); if(t.startsWith('"')&&t.endsWith('"')) t=t.slice(1,-1); return t.replaceAll('\\"','"'); }
function fromSieDate(yyyymmdd){ if(!yyyymmdd||!/^(\d{8})$/.test(yyyymmdd)) return ""; return `${yyyymmdd.slice(0,4)}-${yyyymmdd.slice(4,6)}-${yyyymmdd.slice(6,8)}`; }
function parseSIE(text){
  const lines = String(text||"").split(/\r?\n/).map(l=>l.trim()).filter(l=>l && !l.startsWith("{") && !l.startsWith("}"));
  const accounts = [];
  const vouchers = [];
  let current = null;
  for(const line of lines){
    if(line.startsWith("#KONTO")){
      const m = line.match(/^#KONTO\s+(\d+)\s+(".*")\s*$/);
      if(m){
        accounts.push({no:m[1], name:unquote(m[2]), type:guessTypeFromBAS(m[1]), vat:guessVatFromBAS(m[1])});
      }
      continue;
    }
    if(line.startsWith("#VER")){
      const m = line.match(/^#VER\s+"([^"]+)"\s+(\d+)\s+(\d{8})\s+(".*")\s*$/);
      if(m){
        if(current) vouchers.push(finalizeImportedVoucher(current));
        current = { series:m[1], no:Number(m[2]), date:fromSieDate(m[3]), text:unquote(m[4]), lines:[] };
      }
      continue;
    }
    if(line.startsWith("#TRANS")){
      const m = line.match(/^#TRANS\s+(\d+)\s+\{[^}]*\}\s+([-0-9.,]+)\s+(\d{8})\s+(".*")\s*$/);
      if(m && current){
        const account = m[1];
        const amount = parseSieNumber(m[2]);
        const debit = amount >= 0 ? amount : 0;
        const credit = amount < 0 ? Math.abs(amount) : 0;
        current.lines.push({account, debit, credit});
      }
      continue;
    }
  }
  if(current) vouchers.push(finalizeImportedVoucher(current));
  return {accounts, vouchers};
}
function finalizeImportedVoucher(v){
  const agg = new Map();
  for(const l of v.lines){
    const key = String(l.account);
    if(!agg.has(key)) agg.set(key, {account:key, debit:0, credit:0});
    const a = agg.get(key);
    a.debit += toNumber(l.debit);
    a.credit += toNumber(l.credit);
  }
  const lines = [...agg.values()].filter(x=>Math.abs(x.debit)+Math.abs(x.credit) > 0.00001);
  return { id: crypto.randomUUID(), date: v.date || nowISODate(), series:String(v.series||"A").toUpperCase(), no:Number(v.no||1), text:v.text||"", lines };
}
function importSIEText(text, dupeMode="skip"){
  const parsed = parseSIE(text);
  let addedAccounts = 0;
  for(const a of parsed.accounts){
    const ex = db.accounts.find(x=>String(x.no)===String(a.no));
    if(!ex){ db.accounts.push(a); addedAccounts++; }
    else if(!ex.name && a.name) ex.name = a.name;
  }
  let addedVouchers = 0, skippedVouchers = 0;
  for(const v of parsed.vouchers){
    const dup = db.vouchers.find(x=>String(x.series).toUpperCase()===String(v.series).toUpperCase() && Number(x.no)===Number(v.no));
    if(dup){
      if(dupeMode==="replace"){ dup.date=v.date; dup.text=v.text; dup.lines=v.lines; logEvent("sie.replace", `Ersatte ${v.series}${v.no} från SIE.`); }
      else skippedVouchers++;
      continue;
    }
    db.vouchers.push(v);
    addedVouchers++;
  }
  db.seriesNext = db.seriesNext || {};
  for(const v of db.vouchers){
    const s = String(v.series||"A").toUpperCase();
    db.seriesNext[s] = Math.max((db.seriesNext[s]||1), Number(v.no||0)+1);
  }
  logEvent("import.sie", `Importerade SIE: +${addedAccounts} konton, +${addedVouchers} verifikat, skippade ${skippedVouchers}, mode=${dupeMode}.`);
  scheduleSave();
  return {addedAccounts, addedVouchers, skippedVouchers};
}
$("btnImportSIE").addEventListener("click", ()=>{
  try{
    const mode = $("sieDupe").value;
    const res = importSIEText($("sieIn").value, mode);
    $("importMsg").textContent = `SIE-import klar. Konton: +${res.addedAccounts}, Verifikat: +${res.addedVouchers}, Skippade: ${res.skippedVouchers}`;
    setStatus("SIE import klar.","ok");
    showTab("start");
  }catch(e){
    $("importMsg").innerHTML = `<span class="err">${escapeHtml(e.message || String(e))}</span>`;
    setStatus("SIE importfel.","err");
  }
});
$("btnImportSIEFile").addEventListener("click", async ()=>{
  const f = $("sieFile").files && $("sieFile").files[0];
  if(!f) return;
  try{
    const mode = $("sieDupe").value;
    const res = importSIEText(await f.text(), mode);
    $("importMsg").textContent = `SIE-import klar (${f.name}). Konton: +${res.addedAccounts}, Verifikat: +${res.addedVouchers}, Skippade: ${res.skippedVouchers}`;
    setStatus("SIE import klar.","ok");
    showTab("start");
  }catch(e){
    $("importMsg").innerHTML = `<span class="err">${escapeHtml(e.message || String(e))}</span>`;
    setStatus("SIE importfel.","err");
  }
});

function sieDate(iso){ return iso ? iso.replaceAll("-", "") : ""; }
function escapeSie(s){ return String(s).replaceAll('"','\\"'); }
function generateSIE(db){
  const c = db.company || {};
  const fyStart = c.fyStart ? sieDate(c.fyStart) : "";
  const fyEnd = c.fyEnd ? sieDate(c.fyEnd) : "";
  const genDate = sieDate(nowISODate());
  const prog = "SPCSBOK_HTML_V2";
  let out = [];
  out.push(`#FLAGGA 0`);
  out.push(`#PROGRAM "${prog}" 2.0`);
  out.push(`#FORMAT PC8`);
  out.push(`#GEN ${genDate} "${escapeSie(c.name||"")}"`);
  if(c.org) out.push(`#ORGNR ${escapeSie(c.org)}`);
  if(fyStart && fyEnd) out.push(`#RAR 0 ${fyStart} ${fyEnd}`);
  for(const a of (db.accounts||[]).slice().sort((x,y)=>String(x.no).localeCompare(String(y.no),"sv"))){
    out.push(`#KONTO ${a.no} "${escapeSie(a.name||"")}"`);
  }
  const vs = (db.vouchers||[]).slice().sort((a,b)=>{
    if(a.date!==b.date) return a.date.localeCompare(b.date);
    const s = String(a.series).localeCompare(String(b.series),"sv");
    if(s!==0) return s;
    return Number(a.no)-Number(b.no);
  });
  for(const v of vs){
    const vdate = sieDate(v.date);
    const serie = escapeSie(String(v.series||"A").toUpperCase());
    const nr = String(v.no||"");
    const text = escapeSie(v.text||"");
    out.push(`#VER "${serie}" ${nr} ${vdate} "${text}"`);
    for(const l of (v.lines||[])){
      const acc = String(l.account);
      const amount = (toNumber(l.debit) - toNumber(l.credit));
      out.push(`#TRANS ${acc} {} ${money(amount)} ${vdate} "${text}"`);
    }
    out.push(`{`); out.push(`}`);
  }
  out.push(`#SIETYPE 4`);
  return out.join("\r\n");
}

function renderLog(){
  $("diag").innerHTML = `
    <div>Version</div><div>${escapeHtml(String(db.meta?.version ?? "—"))}</div>
    <div>Skapad</div><div class="mono">${escapeHtml(String(db.meta?.createdAt ?? "—"))}</div>
    <div>Lagring</div><div>${escapeHtml(storageMode)}</div>
    <div>Konton</div><div>${db.accounts.length}</div>
    <div>Verifikat</div><div>${db.vouchers.length}</div>
    <div>Loggrader</div><div>${(db.audit||[]).length}</div>
  `;
  const rows = (db.audit||[]).slice(0, 500);
  $("logTable").innerHTML = rows.map(e=>`
    <tr>
      <td class="mono">${escapeHtml(e.ts.replace("T"," ").replace("Z",""))}</td>
      <td class="mono">${escapeHtml(e.action)}</td>
      <td>${escapeHtml(e.detail||"")}</td>
    </tr>
  `).join("") || `<tr><td colspan="3" class="muted">Ingen logg ännu.</td></tr>`;
}
$("btnLogRefresh").addEventListener("click", renderLog);
$("btnLogClear").addEventListener("click", ()=>{
  if(!confirm("Töm loggen?")) return;
  db.audit = [];
  logEvent("audit.clear", "Tömde logg.");
  scheduleSave();
  renderLog();
});

(async function init(){
  await storageInit();
  await loadOrInitDB();
  setStoragePill();
  setStatus("Redo","ok");
  showTab("start");
})();
</script>
</body>
</html>
